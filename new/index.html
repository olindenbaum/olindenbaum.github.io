<!doctype html>
<html>

<head>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        #canvas {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <canvas id="canvas"></canvas>
    <script src="https://cdn.babylonjs.com/babylon.max.js"></script>
    <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.js"></script>
    <script type="text/javascript">
        window.addEventListener("DOMContentLoaded", function () {
            let mug;
            let walls;
            let table_top;
            let keyboard;
            let inner_coffee;
            let monitor;
            let lamp = { "bulb": null, "stem": null, "base": null, "shade": null, "switch": null, "value": false };

            var canvas = document.getElementById("canvas");
            var engine = new BABYLON.Engine(canvas, true);

            var createScene = function () {
                var scene = new BABYLON.Scene(engine);
                scene.clearColor = new BABYLON.Color3.Purple();
                var light0 = new BABYLON.PointLight("Omni", new BABYLON.Vector3(-18, 28, -12), scene);

                var material = new BABYLON.StandardMaterial("std", scene);
                material.diffuseColor = new BABYLON.Color3(0.5, 1, 2);
                var screen_overlay = BABYLON.Mesh.CreateBox("screen_overlay", 1.0, scene); //TODO make curved
                screen_overlay.scaling = new BABYLON.Vector3(13.8, 7.600, 0.05);
                screen_overlay.position = new BABYLON.Vector3(0, 20.68, 4);
                screen_overlay.material = material;
                screen_overlay.isPickable = true;



                BABYLON.SceneLoader.ImportMesh(
                    null,
                    " ./",
                    "website.obj",
                    scene,
                    function (meshes) {
                        // scene.createDefaultCameraOrLight(true, true, true); //use for viewing whole scene
                        // scene.createDefaultEnvironment();

                        //log the name of the meshes we just imported
                        for (var i = 0; i < meshes.length; i++) {
                            // console.log(meshes[i].name);
                            if (meshes[i].name == "Coffee_Cylinder") {
                                inner_coffee = meshes[i];
                                inner_coffee.material.diffuseColor = BABYLON.Color3.FromHexString("#6f4e37");
                                setupCoffeeAnimation(inner_coffee);
                            }
                            else if (meshes[i].name == "tea_mug_Cylinder") {
                                mug = meshes[i];
                                mug.isPickable = true;
                            }
                            else if (meshes[i].name == "walls") {
                                walls = meshes[i];
                            }
                            else if (meshes[i].name == "10105_Computer_Keyboard_v1_L3") {
                                keyboard = meshes[i];
                                keyboard.isPickable = true;
                            }
                            else if (meshes[i].name == "table_top") {
                                table_top = meshes[i];
                            }
                            else if (meshes[i].name == "Monitor_27'_Curved") {
                                monitor = meshes[i];
                            }
                            else if (meshes[i].name == "capana") {
                                lamp['shade'] = meshes[i];
                            }
                            else if (meshes[i].name == "Conector") {
                                meshes[i].isPickable;
                                lamp['base'] = meshes[i];
                            }
                            else if (meshes[i].name == "cuello") {
                                meshes[i].isPickable;
                                lamp['stem'] = meshes[i];
                            }
                            else if (meshes[i].name == "bombilla") {
                                meshes[i].isPickable;
                                lamp['bulb'] = meshes[i];
                            }
                            else if (meshes[i].name == "interruptor") {
                                meshes[i].isPickable;
                                lamp['switch'] = meshes[i];
                            }
                        }


                    }
                );



                setupPickHandlerBabylon(scene);


                var freeCamera = new BABYLON.FreeCamera("FreeCamera", new BABYLON.Vector3(0, 24, -20), scene);
                freeCamera.rotation = new BABYLON.Vector3(0.35, 0, 0);
                scene.activeCamera = freeCamera;
                // freeCamera.attachControl(canvas, true);
                scene.activeCamera.attachControl(canvas, true);

                return scene;
            }


            // var buttonbox = document.createElement('div');
            // buttonbox.id = "buttonbox";
            // buttonbox.style.position = "absolute";
            // buttonbox.style.top = "60px";
            // buttonbox.style.left = "85%";
            // buttonbox.style.border = "5pt inset blue";
            // buttonbox.style.padding = "2pt";
            // buttonbox.style.paddingRight = "2pt";
            // buttonbox.style.width = "10em";
            // buttonbox.style.display = "block";
            // document.body.appendChild(buttonbox);


            // var tTag = document.createElement('div');
            // tTag.id = "choose";
            // tTag.textContent = "Mesh name";
            // tTag.style.textAlign = "center";
            // tTag.style.border = "2pt solid gold";
            // tTag.style.marginLeft = "1.5pt";
            // tTag.style.marginTop = "3pt";
            // tTag.style.marginBottom = "2pt";
            // tTag.style.backgroundColor = "dodgerblue";
            // tTag.style.width = "96%";
            // tTag.style.fontSize = "1.0em";
            // tTag.style.color = "white";
            // buttonbox.appendChild(tTag);


            // var header = document.createElement('div');
            // header.id = "header";
            // header.textContent = "No Picked Mesh";
            // header.style.textAlign = "center";
            // header.style.marginTop = "3pt";
            // header.style.marginBottom = "2pt";
            // header.style.border = "2pt solid red";
            // header.style.marginLeft = "1.5pt";
            // header.style.backgroundColor = "teal";
            // header.style.width = "96%";
            // header.style.fontSize = "1.0em";
            // header.style.color = "black";
            // buttonbox.appendChild(header);





            var scene = createScene();


            // scene.debugLayer.show();
            engine.runRenderLoop(function () {

                // var light  = scene.getLightByName("Omni");
                // var coffee_level = scene.getMeshByID("Coffee_Cylinder");
                // coffee_level.position.y += 0.01;
                // if (coffee_level.position.y > 0.6) {
                //     coffee_level.position.y = 0;
                // }
                // light.y -= 0.01;
                scene.render();
            });


            function setupPickHandlerBabylon(scene) {
                scene.onPointerObservable.add(function (pInfo) {
                    var dpic = scene.pick(scene.pointerX, scene.pointerY);
                    if (pInfo.type === BABYLON.PointerEventTypes.POINTERTAP) {
                        // var header = document.getElementById("header");
                        // header.textContent = dpic.pickedMesh.name;
                        if (dpic.pickedMesh != null) {
                            if (mug != null) {
                                if (dpic.pickedMesh.name == mug.name) {
                                    // var tmp = scene.getMeshByName(mug.name);
                                    runCoffeeAnimation(scene);

                                }
                            }
                            if (monitor != null) {
                                if (dpic.pickedMesh.name == monitor.name) {
                                    // var tmp = scene.getMeshByName(mug.name);
                                    monitor.material.diffuseColor = BABYLON.Color3.FromHexString("#" + Math.floor(Math.random() * 16777215).toString(16));

                                }
                            }
                            if (lamp['switch'] != null && lamp['bulb'] != null && lamp['base'] != null) {
                                if (dpic.pickedMesh.name == lamp['switch'].name || dpic.pickedMesh.name == lamp['base'].name) {
                                    if (lamp['value'] == true) {
                                        lamp['base'].material.diffuseColor = BABYLON.Color4.FromHexString("#00fad16b");
                                        lamp['value'] = false;
                                    } else {
                                        lamp['base'].material.diffuseColor = BABYLON.Color4.FromHexString("#fffad16b");
                                        lamp['value'] = true;
                                    }

                                }
                            }
                        }

                    }
                })
            }

            function setupCoffeeAnimation(inner_coffee) {
                var coffee_keys = [];
                var coffee_liquid_animation = new BABYLON.Animation("coffee_liquid_animation", "position.y", 30, BABYLON.Animation.ANIMATIONTYPE_FLOAT, BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);
                coffee_keys.push({
                    frame: 0,
                    value: 0,
                });
                coffee_keys.push({
                    frame: 45, //as 30fps then frame 45 is 1.5 seconds
                    value: -0.7,
                });
                coffee_keys.push({
                    frame: 90, //as 30fps then frame 45 is 1.5 seconds
                    value: -0.7,
                });
                coffee_keys.push({
                    frame: 120, //as 30fps then frame 45 is 1.5 seconds
                    value: 0,
                });
                coffee_liquid_animation.setKeys(coffee_keys);
                inner_coffee.animations = [];
                inner_coffee.animations.push(coffee_liquid_animation);
            }

            function runCoffeeAnimation(scene) {
                scene.beginAnimation(inner_coffee, 0, 120, true);
            }

        });



    </script>
</body>

</html>